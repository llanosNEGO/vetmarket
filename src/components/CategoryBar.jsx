import { useState, useEffect } from 'react';
import axios from 'axios';

export const CategoryBar = () => {
    const [activeCategory, setActiveCategory] = useState(null);
    const [categories, setCategories] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchCategories = async () => {
            try {
                const response = await axios.get('https://ventas.vetmarket.pe/data/categorias.php');
                const data = response.data.value || response.data;
                
                const transformedCategories = data.map(cat => ({
                    id: cat.id,
                    name: cat.nom,
                    subcategories: cat.sub_menus.map(sub => sub.nom),
                    icon: getIconForCategory(cat.nom)
                }));
                
                setCategories(transformedCategories);
            } catch (error) {
                console.error('Error al cargar categorías:', error);
                setCategories([]);
            } finally {
                setLoading(false);
            }
        };

        fetchCategories();
    }, []);

    const getIconForCategory = (categoryName) => {
        const icons = {
            'Otras Especies': (
                <svg viewBox="0 0 40 32" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-[45px] h-[45px] text-slate-500 group-hover:text-[#008B9C]">
                    <path d="M28.4688 31.8633V25.4362C28.4688 20.5508 24.5104 16.5872 19.6198 16.5872C14.7344 16.5872 10.7708 20.5508 10.7708 25.4362V31.8633H28.4688ZM39.2396 31.3997V15.4206C39.2396 15.2747 39.1771 15.1445 39.0625 15.056L19.9063 0.0976558C19.7396 -0.0325519 19.5052 -0.0325519 19.3385 0.0976558L0.177083 15.056C0.0677073 15.1445 0 15.2747 0 15.4206V31.3997C0 31.6549 0.208334 31.8633 0.463543 31.8633C0.718751 31.8633 0.927083 31.6549 0.927083 31.3997V15.6445L19.6198 1.04557L38.3177 15.6445V31.3997C38.3177 31.6549 38.5208 31.8633 38.776 31.8633C39.0313 31.8633 39.2396 31.6549 39.2396 31.3997ZM15.4219 8.52474C14.8906 8.50911 14.4896 8.76432 14.2604 9.16537C14.0521 9.52995 14.0156 9.93099 14.0938 10.3424C14.1823 10.806 14.3958 11.2018 14.7188 11.5456C15.099 11.9518 15.5573 12.1914 16.1146 12.207C16.5104 12.2122 16.8542 12.0612 17.1094 11.7539C17.3177 11.4987 17.4271 11.1966 17.4375 10.8581C17.4583 10.1393 17.1667 9.55078 16.7813 9.18099C16.3021 8.74349 15.901 8.54037 15.4219 8.52474ZM24.9896 9.10807C24.7396 8.63932 24.3177 8.41537 23.8542 8.42057C23.4323 8.42057 23.0677 8.58724 22.75 8.86328C22.3958 9.17057 22.1563 9.55599 22.0208 10.0039C21.8594 10.5352 21.8802 11.056 22.1458 11.5456C22.3385 11.8945 22.6406 12.1133 23.0313 12.181C23.3594 12.2331 23.6771 12.1758 23.974 12.0143C24.6094 11.6758 24.9688 11.1289 25.1042 10.6081C25.2396 9.97787 25.2135 9.52995 24.9896 9.10807ZM20.3125 5.80599C19.875 5.50911 19.3958 5.50911 18.9948 5.73307C18.6198 5.93099 18.375 6.25391 18.224 6.64453C18.0573 7.08203 18.026 7.52995 18.1146 7.99349C18.224 8.54037 18.4844 8.98307 18.9531 9.29037C19.2865 9.50911 19.6563 9.5612 20.0313 9.4362C20.349 9.33203 20.599 9.12891 20.7865 8.85287C21.1875 8.25391 21.25 7.60287 21.1198 7.07682C20.9479 6.45703 20.7135 6.07161 20.3125 5.80599ZM21.6458 15.6341C21.5 15.6029 21.349 15.5768 21.2031 15.5508C21.1146 15.5352 21.0313 15.5143 20.9479 15.5039C20.3698 15.4466 19.7969 15.3945 19.2188 15.4414C18.9635 15.4622 18.7083 15.4883 18.4583 15.5247C18.3125 15.5404 18.1719 15.5716 18.0313 15.6081C17.7917 15.6758 17.5469 15.6549 17.3073 15.5977C17.0469 15.5352 16.8177 15.4206 16.6563 15.2018C16.5052 14.9987 16.4635 14.7695 16.4948 14.5195C16.5469 14.0768 16.7813 13.7331 17.0938 13.431C17.3073 13.2227 17.5156 13.0091 17.7031 12.7747C17.9219 12.5039 18.0365 12.1862 18.099 11.8424C18.1719 11.4727 18.2865 11.1133 18.5521 10.8216C18.8906 10.4518 19.3229 10.3008 19.8125 10.3477C20.4063 10.4102 20.8281 10.7331 21.0521 11.2904C21.1406 11.5091 21.1927 11.7435 21.2552 11.9727C21.3542 12.3372 21.526 12.6654 21.7865 12.9362C21.9948 13.1602 22.224 13.3685 22.4375 13.5872C22.7083 13.8737 22.8594 14.2227 22.8698 14.6133C22.8802 14.9935 22.7031 15.2643 22.3698 15.4414C22.1458 15.5612 21.9063 15.6133 21.6458 15.6341Z" fill="currentColor"></path>
                </svg>
            ),
            'Gatos': (
                <svg viewBox="0 0 38 30" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-[45px] h-[45px] text-slate-500 group-hover:text-[#008B9C]">
                    <path d="M2.52637 12.8241C2.72412 12.8242 2.87987 12.9808 2.87988 13.1786C2.87988 13.3712 2.72413 13.5329 2.52637 13.5331C2.33366 13.5331 2.17188 13.3713 2.17188 13.1786C2.17189 12.9807 2.33367 12.8241 2.52637 12.8241Z" fill="currentColor"></path>
                    <path fillRule="evenodd" clipRule="evenodd" d="M32.9268 1.95494C33.9788 0.288271 35.4219 -0.190896 36.3125 0.0643132C36.9843 0.262246 37.3857 0.834872 37.3857 1.60045C37.3857 2.28265 36.7919 2.70988 36.2139 3.1317C35.818 3.41295 35.4115 3.71015 35.25 4.04869C34.9272 4.73615 34.9893 5.6113 35.0674 6.62681C35.1247 7.42361 35.1878 8.24149 35.0732 9.09556C34.6044 12.5224 31.9483 14.6372 30.7451 15.2987C31.0835 16.8821 30.6247 19.856 30.458 20.5643C30.2029 21.6475 30.4737 22.7672 30.6924 23.6629C30.8017 24.0951 30.8909 24.47 30.917 24.7928C30.9795 25.5585 29.3281 28.9706 28.7812 29.5643C28.7031 29.6476 28.578 29.7616 28.4062 29.7616H26.7812C26.7031 29.7616 26.6247 29.7355 26.5674 29.6835C26.3075 29.4649 26.2706 29.2257 26.2861 29.0643C26.3122 28.7207 26.5934 28.4547 26.7705 28.3192L27.3594 25.2674C27.2083 25.1112 26.8594 24.8192 26.5469 24.5536C26.4479 24.4702 26.3434 24.3814 26.2393 24.2928C26.1143 24.8814 25.9222 25.7883 25.7607 26.2362C25.4691 27.0642 24.917 27.9338 24.5107 28.5223C23.6462 29.7619 23.4736 29.7616 23.3486 29.7616H21.7236C21.6509 29.7615 21.5728 29.736 21.5156 29.6893C21.3334 29.5383 21.2394 29.3402 21.2549 29.1268C21.2757 28.7468 21.6402 28.4394 21.833 28.2987C22.1611 27.4447 22.5935 25.9812 22.4375 25.4081C22.3281 24.9914 21.7184 24.2307 21.3174 23.7254C21.1508 23.5172 21.0316 23.3657 20.9482 23.246C19.0473 23.397 16.8076 23.5174 15.042 23.5174C14.3338 23.5174 13.7034 23.4966 13.1982 23.4549C13.6201 25.0642 13.8857 27.0484 13.6826 28.1317C13.5368 28.9129 12.8906 29.7518 12.5469 29.7518H10.9531C10.8125 29.7518 10.6875 29.6574 10.6406 29.5272C10.495 29.0951 10.6879 28.7615 10.9014 28.5585C10.5472 27.3346 10.0263 26.574 9.38574 25.8085C7.89129 28.2558 6.22499 29.6262 6.15137 29.6893C6.08887 29.7362 6.0153 29.7616 5.94238 29.7616H4.29199C4.14616 29.7616 4.0153 29.6678 3.97363 29.5272C3.96264 29.4835 3.86021 29.1099 4.0625 28.7362C4.18749 28.5018 4.40109 28.3299 4.6875 28.2206C5.29688 26.9185 5.46387 25.7827 5.46387 25.7723L6.1875 21.2831C5.84375 20.5226 5.5625 19.7463 5.32812 19.0379C5.28126 18.9078 5.22361 18.783 5.16113 18.6581C5.18194 18.757 5.19824 18.856 5.19824 18.9549C5.19809 19.71 4.58324 20.3241 3.82812 20.3241C3.80729 20.3241 3.78646 20.3244 3.76562 20.3192C3.6875 20.3192 3.59896 20.3088 3.51562 20.2879C3.35432 20.2463 3.20337 20.184 3.07324 20.0956C3.02651 20.0644 2.98462 20.033 2.94824 20.0018C2.64102 19.7467 2.46395 19.3611 2.46387 18.9549C2.46387 18.2049 3.07292 17.5897 3.82812 17.5897H3.87012C3.86497 17.5794 3.85944 17.5641 3.85938 17.5487C3.85417 17.5174 3.84863 17.4803 3.84863 17.4491C3.67175 17.3815 3.46879 17.3299 3.26074 17.2987C1.26595 16.9914 0.328125 15.8085 0.28125 14.7772V14.6678C0.114728 14.6105 0.000114263 14.4548 0 14.2674C0 14.028 0.192529 13.835 0.426758 13.8348C0.494466 13.8348 0.562825 13.8504 0.620117 13.8817C0.729343 13.7517 0.853955 13.6423 0.958008 13.5487C1.10368 13.4238 1.24936 13.2935 1.25488 13.2049C1.3382 11.5489 2.92129 10.3246 3.37988 10.0067L3.62012 8.92369C3.63574 8.62681 3.80762 8.35533 4.07324 8.2147C4.33353 8.06913 4.63524 8.08008 4.87988 8.23619C6.47363 9.26223 7.1722 10.2206 7.68262 10.9237C7.88043 11.1944 8.04728 11.4238 8.22949 11.6112C8.3179 11.5696 8.41652 11.5487 8.52051 11.5487C8.93193 11.5643 9.4378 11.8137 9.66699 12.121C9.72428 12.1991 9.76074 12.2883 9.77637 12.3768C12.0212 12.9652 15.6516 12.673 19.167 12.3866C22.7294 12.1001 26.4119 11.8039 28.8389 12.3924C29.3023 12.486 29.8748 12.2927 30.4424 11.8397C31.4111 11.0741 32.411 9.48607 32.458 7.65806C32.4736 7.03316 32.4375 6.41318 32.4062 5.81431C32.3229 4.38218 32.2499 3.03301 32.9268 1.95494Z" fill="currentColor"></path>
                </svg>
            ),
            'Caninos': (
                <svg viewBox="0 0 38 32" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-[45px] h-[45px] text-slate-500 group-hover:text-[#008B9C]">
                    <path d="M37.2188 10.0508C37.2188 9.83724 37.0521 9.67057 36.8438 9.67057C36.6302 9.67057 36.4688 9.83724 36.4688 10.0508C36.4688 10.2591 36.6302 10.4206 36.8438 10.4206C37.0521 10.4206 37.2188 10.2591 37.2188 10.0508Z" fill="currentColor"></path>
                    <path fillRule="evenodd" clipRule="evenodd" d="M26.0781 1.10934C24.974 -0.510826 23.0208 -0.0796756 21.8438 1.10934C20.1771 2.78223 19.7448 6.14809 18.9688 9.86996C17.8802 14.9893 16.4531 21.5508 11.6146 23.3789C11.0625 23.5768 10.474 23.7435 9.85938 23.8789C13.8594 23.888 18.1979 23.4779 19.9323 21.9112C20.5885 21.3122 20.8073 20.5518 20.875 19.8799C21.0312 18.4101 20.5417 16.8164 20.0156 15.1331C19.6302 13.8893 19.2292 12.6143 19.0417 11.3591C19.7865 11.3227 20.5573 11.3019 21.349 11.2966C22.5052 11.2966 23.776 11.3487 25.0938 11.4893C25.375 11.5206 25.6875 11.5831 26.0208 11.6769C26.1719 11.7133 26.3281 11.7549 26.4948 11.7966C28.151 12.2289 29.8698 12.6768 31.6198 13.0778C35.2604 13.9112 37.2448 11.8685 37.6354 11.3278C37.724 11.2081 37.7448 11.0518 37.6927 10.9112C37.6406 10.7654 37.5104 10.6612 37.3698 10.6404C35.625 10.3539 33.9583 9.84372 32.8594 9.51559C32.9219 9.39059 32.974 9.26559 33.0313 9.14059C33.7188 7.67057 33.6927 5.37057 31.9219 4.09892C30.3698 3.00517 28.4219 3.42057 27.3698 4.41934C27.2552 4.52892 27.1406 4.63851 27.0313 4.74809C26.5 3.53226 26.2552 2.23226 26.0781 1.10934ZM11.099 23.9362C11.0833 23.9414 11.0625 23.9466 11.0469 23.9518C11.0677 23.9466 11.0833 23.9414 11.099 23.9362ZM21.2031 2.29809C21.9531 1.1612 23.3438 0.837988 24.0156 1.51559C24.0625 1.56247 24.8125 2.31247 25.2865 6.35934C25.4531 7.56247 25.4583 8.76559 25.4635 9.94809C25.4635 10.3279 25.4635 10.7133 25.4844 11.0935C24.2865 10.9633 23.1198 10.9216 22.0833 10.9268C21.3177 10.9268 20.5781 10.9477 19.8594 10.9893C19.9948 9.93893 20.151 9.00518 20.3125 8.17057C21.0521 4.61934 21.4948 2.6612 21.2031 2.29809ZM31.0729 4.98226C32.474 6.00309 32.4323 7.81768 31.8802 9.00518C31.5833 9.61976 31.1354 10.0987 30.7708 10.4477C30.1563 11.0414 29.6927 11.4893 29.9896 12.1664C30.3125 12.9164 31.1875 13.2862 31.4583 13.3799C31.8854 13.5154 32.3229 13.6404 32.7656 13.7602C30.7708 13.4216 29.0781 12.9893 27.4375 12.5622C27.2917 12.526 27.151 12.4945 27.0052 12.463C26.6615 12.3643 26.3333 12.2966 26.0417 12.2602C24.6458 12.1143 23.2917 12.0622 22.0521 12.0622C21.8646 12.0622 21.6823 12.0674 21.5 12.0674C21.3177 12.0674 21.1354 12.0622 20.9479 12.0622C22.2292 12.3643 23.4635 12.8799 24.4063 13.6299C26.8594 15.5362 27.2292 18.8227 27.3177 20.2602C27.3542 20.9633 27.2917 21.7966 26.8906 22.5674C25.6615 24.888 21.1615 25.463 15.9323 25.4528C13.151 25.4477 9.9948 25.2758 7.28646 24.9372C6.72917 24.8643 6.19271 24.7862 5.66667 24.6924C5.01042 24.5674 4.36458 24.4216 3.72917 24.2549C3.5 24.2029 3.29167 24.0518 3.14583 23.8539C2.97396 23.6143 2.88021 23.3383 2.88021 23.0518C2.88021 22.7758 2.96354 22.5101 3.12501 22.2758C3.22396 22.1351 3.33854 22.0206 3.48438 21.9372C3.50521 21.9268 3.52604 21.9164 3.54688 21.9112C3.67188 21.8435 3.78646 21.7758 3.88542 21.7133C4.09896 21.5726 4.28646 21.4268 4.52604 21.2966C4.76042 21.1716 5.03125 21.0622 5.32292 21.0101C5.66146 20.9529 6.04167 20.9581 6.42708 21.1716C6.95313 21.4581 7.11458 21.9164 7.12501 22.1039C7.13021 22.2445 7.25 22.3539 7.39063 22.3539H7.39583C7.54167 22.3487 7.65625 22.2289 7.65625 22.0831C7.65625 21.8487 7.51563 21.4633 7.32813 21.1716C7.16667 20.9216 6.95833 20.7133 6.71354 20.5622C6.32292 20.3122 5.84375 20.2393 5.40625 20.3174C5.04167 20.3799 4.70833 20.5205 4.41146 20.6768C4.13021 20.8227 3.88542 21.0049 3.61458 21.1924C3.49479 21.2758 3.35937 21.3591 3.20312 21.4424C3.16146 21.4633 3.125 21.4893 3.08333 21.5101C2.82813 21.6456 2.63021 21.8695 2.49479 22.1091C2.24479 22.5258 2.125 23.0049 2.13021 23.4789C2.13542 23.9268 2.26042 24.3695 2.53646 24.7341C2.8125 25.0987 3.21875 25.3591 3.67188 25.4737C4.30729 25.6299 4.96354 25.7706 5.62501 25.8956C6.15625 25.9893 6.69792 26.0674 7.25521 26.1404C9.45833 26.4164 11.9792 26.6143 14.6458 26.7341C16.9323 26.8383 19.4323 26.8851 21.7708 26.599C21.8646 27.3851 21.7396 28.2862 21.474 29.0779C21.4219 29.2497 21.5156 29.4268 21.6823 29.4841C21.849 29.5413 22.0313 29.4477 22.0833 29.2758C22.3802 28.388 22.5052 27.3591 22.4063 26.4268C23.7969 26.1872 25.1563 25.7341 26.0365 24.8174C26.7552 24.0674 27.0625 23.0622 27.1354 22.0674C27.3281 19.0987 27.3802 16.2602 28.7448 14.7289C29.5104 13.8851 30.5469 13.4528 31.6927 13.3643C31.9323 13.3487 32.1771 13.3539 32.4219 13.3799C32.6927 13.4112 32.9688 13.4737 33.2292 13.5726C33.4844 13.6664 33.7292 13.7914 33.9167 13.9997C34.2135 14.3174 34.3438 14.7393 34.3854 15.151C34.4583 15.8539 34.2708 16.5622 34.0781 17.0674C33.6979 18.0518 33.1302 18.8122 32.2448 19.2445C31.3802 19.6716 30.2708 19.7445 28.8802 19.4477C28.7604 19.4216 28.6406 19.4893 28.6042 19.6039C28.5729 19.7237 28.6406 19.8487 28.7552 19.88C30.25 20.1976 31.4427 20.1299 32.3958 19.6612C33.3906 19.1768 34.0208 18.3174 34.4323 17.2393C34.6406 16.6872 34.8542 15.8799 34.7708 15.0779C34.7292 14.5935 34.5625 14.0987 34.1927 13.7185C33.9583 13.4789 33.6667 13.3226 33.3698 13.2028C33.0781 13.0882 32.776 13.0101 32.4635 12.9685C32.1458 12.9268 31.8281 12.9216 31.5156 12.9425C30.3646 13.026 29.3021 13.4372 28.5 14.3018C27.3385 15.5726 27.0469 17.724 26.8854 19.9945C26.8177 20.9268 26.5208 21.8539 25.8594 22.5518C25.0156 23.4372 23.6198 23.9268 21.8906 24.1872C20.0677 24.4581 17.8542 24.4112 15.7135 24.3227C13.1823 24.2185 10.9063 24.0153 9.01042 23.724C9.63021 23.5935 10.224 23.4268 10.7917 23.2185C15.9271 21.2602 17.4115 14.474 18.5365 9.19266C19.3542 5.26558 19.8177 1.47911 21.7708 -0.473889C23.1094 -1.81243 25.3229 -2.29681 26.5625 0.614326C27.4375 2.45318 27.7031 4.46359 28.0052 6.55734C28.1927 7.89588 28.3958 9.27619 28.8125 10.5304C28.974 10.9841 29.3333 11.2393 29.8125 11.2341C30.0365 11.2341 30.2865 11.1768 30.5208 11.0778C30.974 10.8851 31.3698 10.5726 31.7083 10.2393C32.2552 9.69787 32.6458 9.08849 33.0469 8.16537C33.3594 7.50912 33.9219 6.13942 33.5156 4.81246C33.1667 3.66537 32.2917 2.85422 31.0729 4.98226Z" fill="currentColor"></path>
                </svg>
            )
        };
        
        return icons[categoryName] || icons['Otras Especies'];
    };

    if (loading) {
        return (
            <div className="bg-slate-100 py-4">
                <div className="w-full px-4 md:px-12 max-w-screen-2xl mx-auto">
                    <div className="text-center text-gray-500">Cargando categorías...</div>
                </div>
            </div>
        );
    }
    

return (
        <nav className="w-full bg-white py-4 relative z-50">
            <div className="container mx-auto px-4">
                
                {/* BARRA GRIS PRINCIPAL */}
                <div className="bg-gray-50 rounded-xl py-4 px-2 sm:px-6 w-full relative">
                    <ul className="flex flex-nowrap md:justify-around items-center gap-8 overflow-visible">    
                        {categories.map((category, index) => {
                            // Verificamos si este ítem es el que tiene el mouse encima
                            const isActive = activeCategory === index;

                            return (
                                <li 
                                    key={index} 
                                    className="shrink-0"
                                    // 3. EVENTOS MOUSE
                                    onMouseEnter={() => setActiveCategory(index)}
                                    onMouseLeave={() => setActiveCategory(null)}
                                >
                                    <a 
                                        href="#" 
                                        className="group flex flex-col items-center justify-center gap-2 transition-transform duration-200"
                                    >
                                        {/* ICONO */}
                                        <div className={`w-[45px] h-[45px] transition-colors duration-200 
                                            ${isActive ? 'text-red-600' : 'text-slate-500'} 
                                        `}>
                                            {category.icon}
                                        </div>

                                        {/* TEXTO */}
                                        <span className={`font-bold text-xs sm:text-sm uppercase tracking-wide transition-colors duration-200
                                            ${isActive ? 'text-red-600' : 'text-[#008B9C]'}
                                        `}>
                                            {category.name}
                                        </span>     
                                    </a>

                                    {/* 4. EL SUBMENÚ (PANEL BLANCO) */}
                                    {/* Solo se renderiza si tiene subcategorías y está activo */}
                                    {category.subcategories.length > 0 && isActive && (
                                        <div className="absolute left-0 top-full mt-2 w-full bg-white shadow-lg rounded-xl border border-gray-100 p-6 z-50 animate-in fade-in slide-in-from-top-2 duration-200">
                                            <div className="container mx-auto grid grid-cols-3 gap-4">
                                                {category.subcategories.map((sub, i) => (
                                                    <a 
                                                        key={i} 
                                                        href="#" 
                                                        className="text-gray-700 hover:text-red-600 font-medium text-sm block px-4 py-2 hover:bg-gray-50 rounded-md"
                                                    >
                                                        {sub}
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </li>
                            );
                        })}                
                    </ul>   
                </div>

            </div>
        </nav>
    );
}